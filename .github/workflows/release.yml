name: Upload Website to S3 and Release to the npm
on:
  pull_request:
    types: [closed]
    branches:
      - test-dev

jobs:
  # deploy:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3

  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 16

  #     - name: Configure AWS Credentials
  #       uses: aws-actions/configure-aws-credentials@v1
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_GITHUB_S3_PUSHER_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_GITHUB_S3_PUSHER_SECRET_ACCESS_KEY }}
  #         aws-region: us-east-2

  #     - uses: dkershner6/aws-ssm-getparameters-action@v1
  #       with:
  #         parameterPairs: '/dev/deploy/storybook/env = ENV'

  #     - name: save env to .env
  #       run: |
  #         cat << EOF > .env
  #         ${{ env.ENV }}
  #         EOF

  #     - name: Load .env file
  #       uses: xom9ikk/dotenv@v2

  #     - name: npm ci --force
  #       run: npm ci --force

  #     - name: Build
  #       run: npm run build-storybook

  #     - uses: TimekillerTK/s3-sync-action@master
  #       with:
  #         args: --follow-symlinks --delete
  #       env:
  #         SOURCE_DIR: 'storybook-static'
      # - name: Deploy static site to S3 bucket
      #   run: aws s3 sync storybook-static/ s3://devstorybookstack-cbdevwebsitebucketc58c9965-1jfk0b98fa099

  release:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js 16.x
        uses: actions/setup-node@v3
        with:
          version: 16.x

      - name: Install deps and build (with cache)
        uses: bahmutov/npm-install@v1
      - name: Set Git config
        run: |
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"
      
      # - name: Create Release Pull Request or Publish to npm
      #   uses: changesets/action@v1
      #   with:
      #     publish: npm run release
      - name: release
        run: npm run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}